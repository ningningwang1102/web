"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}$define(["pl_util","cmsAjax","pl_toast"],function(u,c,t){function getElemCname(t,e){var a="",n=[{name:"表单容器",code:"e_form"},{name:"单行输入框",code:"e_input"},{name:"数字输入框",code:"e_number"},{name:"多行输入框",code:"e_textarea"},{name:"下拉单选",code:"e_select"},{name:"下拉多选",code:"e_multipleSelect"},{name:"单选项",code:"e_radio"},{name:"多选项",code:"e_checkbox"},{name:"标签型",code:"e_label"},{name:"日期型",code:"e_date"},{name:"区间日期型",code:"e_rangeDate"},{name:"评分、评价",code:"e_score"},{name:"按钮",code:"e_formBtn"},{name:"地址型",code:"e_address"},{name:"图片型",code:"e_uploadImg"},{name:"文件型",code:"e_uploadFile"},{name:"视频型",code:"e_uploadVideo"},{name:"子表单",code:"e_subForm"},{name:"相关项",code:"e_relevantItem"},{name:"条款条件",code:"e_agreement"},{name:"安全验证",code:"e_code"},{name:"手机号验证",code:"e_mobileCode"},{name:"邮箱验证",code:"e_emailCode"},{name:"图文标签",code:"e_cardLabel"}].find(function(e){return e.code==t.split("-")[0]});return n&&(a=n.name),a}function getElemValue(t,e){var a=t.split("-")[0],n="",o=$("#"+e+" ."+t);switch(a){case"e_input":case"e_clueMobile":case"e_clueName":case"e_clueEmail":n=getInputValue(t,e);break;case"e_number":case"e_textarea":case"e_date":0==(l=o.find('[name="'+t+'"]')).length&&(l=o.find('[data-name="'+t+'"]'));n=getDateFormat(i=l.val(),t,e);break;case"e_select":case"e_multipleSelect":case"e_score":0==(l=o.find('[name="'+t+'"]')).length&&(l=o.find('[data-name="'+t+'"]')),n=getOption(i=l.val(),t,e);break;case"e_radio":case"e_checkbox":case"e_label":case"e_cardLabel":var i=[],r=".form-check";o.hasClass("formHide")||(r=".form-check:visible"),o.find(r).each(function(){var e=$(this).find('[name="'+t+'"]');0==e.length&&(e=$(this).find('[data-name="'+t+'"]')),e.is(":checked")&&i.push(e.val())}),n=getOption(i.join(","),t,e);break;case"e_rangeDate":var r=o.find("[name='"+t+"-start']"),c=o.find("[name='"+t+"-end']");0==r.length&&(r=o.find("[data-name='"+t+"-start']")),0==c.length&&(c=o.find("[data-name='"+t+"-end']")),n={start:r.val(),end:c.val()};break;case"e_address":case"e_uploadFile":case"e_uploadImg":case"e_uploadVideo":0==(l=o.find('[name="'+t+'"]')).length&&(l=o.find('[data-name="'+t+'"]')),n=l.val()?JSON.parse(l.val()):[];break;case"e_subForm":n=getSubFormVaue(t,e);break;case"e_relevantItem":n=getRelevantItemValue(t,e);break;case"e_mobileCode":case"e_emailCode":var c=o.find("[name='"+t+"-Number']"),l=o.find("[name='"+t+"-Code']");0==c.length&&(c=o.find("[data-name='"+t+"-Number']")),0==l.length&&(l=o.find("[data-name='"+t+"-Code']")),n={number:c.val(),code:l.val()}}return n}function getDateFormat(e,t,a){if(!e)return"";var n,o,i,r,t=getProp(t,a),a=e;return"date"==t.type&&(t=t.format.split("-"),n=e.split("-"),t.forEach(function(e,t){/Y/.test(e)?o=n[t]:/M/.test(e)?i=n[t]:/D/.test(e)&&(r=n[t])}),a=o+"-"+i+"-"+r),a}function getInputValue(e,t){var a=getProp(e,t),n=$("#"+t+" ."+e),t=n.find('[name="'+e+'"]');return 0==t.length&&(t=n.find('[data-name="'+e+'"]')),"countryMobile"==a.type||"countryTel"==a.type?{callingCode:n.find("[name='phoneDail']").val(),countryCode:n.find("[name='phoneIso']").val(),phoneNumber:t.val()}:t.val()}function getOpt(e,t){var a=$("#"+t+" ."+e),n=e.split("-")[0],o=[];return-1<["e_checkbox","e_radio","e_label","e_cardLabel"].indexOf(n)?a.find(".form-check").each(function(){var e=$(this).find(".form-check-input"),e={label:$(this).find(".form-check-label").text(),value:e.val()};"e_cardLabel"==n&&(e.label=$(this).find(".p_title").text(),e.img=$(this).find(".p_img span").attr("data-src")),o.push(e)}):"e_multipleSelect"==n?a.find(".multSelect-option div").each(function(){o.push({label:$(this).find("span").text(),value:$(this).attr("data-value")})}):"e_select"==n&&(0==(t=a.find('[name="'+e+'"]')).length&&(t=a.find('[data-name="'+e+'"]')),t.find("option").each(function(){""!=$(this).attr("value")&&o.push({label:$(this).text(),value:$(this).attr("value")})})),o}function getOption(e,o,t){var i=[],r=$("#"+t+" ."+o),c=getProp(o,t),l=getOpt(o,t);e.split(",").forEach(function(e){var t,a,n;e&&(t=e,n={},-1<o.indexOf("e_score")?(t=Math.ceil(e.split("/")[0]),a=c.prompt.find(function(e){return e.from<=t&&e.to>=t}),n.score=e):(a=l.find(function(e){return e.value==t}),n.value=e),n.label=a?a.label:t,-1<o.indexOf("e_cardLabel")&&(e=r.find('[value="'.concat(e,'"]')),(n=JSON.parse(e.parent(".p_labelItem").attr("data-value"))).label=unescape(n.label)),i.push(n))});return-1<["e_radio","e_select","e_score"].indexOf(o.split("-")[0])&&(i=i[0]||{}),i}function getRelevantItemValue(e,t){var a=$("#"+t+" ."+e),n=0<a.closest("[class^=e_subForm-]").length,t=getProp(e,t),o=!1;t.previewList.forEach(function(e){e.openLink&&(o=!0)});var i=[];return n?(i={},a.attr("datakey")&&(i[a.attr("datakey")]=a.attr("datavalue")||""),a.find(".p_relevantTd").each(function(){i[$(this).attr("datakey")]=$(this).attr("datavalue")||""}),o&&(n=JSON.parse(unescape(a.attr("dataobj"))),i.href=n.href||n._href||"")):a.find(".p_tabelList tbody tr").each(function(e,t){var a={};a[$(this).attr("datakey")]=$(this).attr("datavalue")||"",$(this).find("td").each(function(){$(this).hasClass("op")||(a[$(this).attr("datakey")]=$(this).attr("datavalue")||"")}),o&&(t=JSON.parse(unescape($(t).attr("dataobj"))),a.href=t.href||t._href||""),i.push(a)}),i}function getSubFormVaue(e,n){var e=$("#"+n+" ."+e),t=[];return e.find(".p_tbody .p_tr:visible").each(function(){var a,e=$(this);0!=e.height()&&(a={},e.find("[class^='e_']").each(function(){var e=$(this).attr("class").split(/\s+/).find(function(e){return/^e_/.test(e)}),t=e;e.indexOf("__")&&(t=t.split("__")[0]),a[t]=getElemValue(e,n)}),t.push(a))}),t}function getProp(e,t){var a,t=$("#"+t).children("input:hidden[name='propJson']").val(),n=t?JSON.parse(t):{},o={},i=e.split("-")[1];for(a in i.indexOf("__")&&(i=i.split("__")[0]),n)a.split("_")[1]==i&&(o[a.split("_")[0]]=n[a]);return o}function formProp(e,t){var t=$("#"+t).children("input:hidden[name='propJson']").val(),a=JSON.parse(t),e=$("."+e).closest("[class^='e_form-']").attr("class").split(/\s+/).find(function(e){return/^e_/.test(e)}),n={};if(e){var o,i=e.split("-")[1];for(o in i.indexOf("__")&&(i=i.split("__")[0]),a)o.split("_")[1]==i&&(n[o.split("_")[0]]=a[o])}return n}function getElemLabel(e,t){var a=this.getProp(e,t);return a.label||this.getElemCname(e,t)}function getListContent(e,t,a){if(a){var n=t[e.outCode];return-1<["array[markList]","array[images]","array[img]","array[keywords]","object","array[category]","array[video]","array[file]"].indexOf(e.outType)&&(n=n?JSON.stringify(n).toString():""),n}var o,i,r,c,a=t[e.outCode]||"",n="p_listWord";return"array[img]"==e.outType||"array[images]"==e.outType?((o=t[e.outCode]?t[e.outCode][0]:{})&&(a='<img src="'.concat($.handleDataImg(o.imageUrl),'">')),n="p_listImg"):"array[video]"==e.outType?((o=t[e.outCode]?t[e.outCode][0]:{})&&(a='<img src="'.concat($.handleDataImg(o.coverImgUrl),'">')),n="p_listImg"):"array[file]"==e.outType||"array[category]"==e.outType?(i=[],t[e.outCode]&&(t[e.outCode].forEach(function(e){i.push(e.title)}),a=i.join(","))):"array[keywords]"==e.outType?(r=[],t[e.outCode]&&(t[e.outCode].forEach(function(e){r.push(e.itemName)}),a=r.join(","))):"array[markList]"==e.outType?(c=[],t[e.outCode]&&(t[e.outCode].forEach(function(e){c.push(e.markName)}),a=c.join(","))):"object"==e.outType&&t[e.outCode]&&(a=t[e.outCode].title),e.openLink&&(t=t.href||t._href,a='<a href="'.concat(t,'" target="').concat(e.linkTarget,'">')+a+"</a>"),'<div class="'.concat(n,'" name="').concat(e.outCode,'">').concat(a,"</div>")}function txRule(a,e,t){var n=a.if.value,o=getElemValue(a.if.item,t),i=!0,r="";switch(Object.prototype.toString.call(o)){case"[object String]":case"[object Number]":""!=(r=o)&&(i=!1);break;case"[object Object]":0<(r=o.value?[o.value]:[]).length&&(i=!1);break;case"[object Array]":r=[],o.forEach(function(e){e.value&&r.push(e.value)}),0<r.length&&(i=!1)}var c=1==n&&!i;return c&&0<a.if.option.length&&(a.if.option.forEach(function(e,t){a.if.option[t]=e.toString()}),c=-1<["e_radio","e_select"].indexOf(a.if.item.split("-")[0])||"e_label"==a.if.item.split("-")[0]&&1==getProp(a.if.item,t).limit?-1<a.if.option.indexOf(r[0]):a.if.option.toString()==r.toString()),e?c:2==n&&i}function doAction(e,t,a,n,o){"[object Object]"==Object.prototype.toString.call(e)?doActionSingle(e,t,a,n,o):"[object Array]"==Object.prototype.toString.call(e)&&e.forEach(function(e){e.state&&doActionSingle(e,t,a,n,o)})}function doActionSingle(e,t,a,n,o){1!=e.type&&e.type?2==e.type?changeItemOption(e,t,a,n):3==e.type?changeItemValue(e,t,a,n,o):4==e.type&&doLogic(e,t,a,n,o):changeItemType(e,t,a,n)}function doLogic(e,t,a,n,r){if(t){var c,l,u=$("#".concat(n," .").concat(a));for(c in e.itemValue)e.itemValue[c]&&function(){var o=r[c],i=calculation(o.formula,n),e=o.formula.find(function(e){return"subFormRow"==e.type});o.output&&(e?u.find(".".concat(e.subform)).find(".p_tr").each(function(e,t){var a="";0!=e&&(a="__"+(e+1));var n=$(t).find('[name="'.concat(o.output).concat(a,'"]'));0==n.length&&(n=$(t).find('[data-name="'.concat(o.output).concat(a,'"]'))),n.val(i[e])}):(0==(l=u.find('[name="'+o.output+'"]')).length&&(l=u.find('[data-name="'+o.output+'"]')),l.val(i)))}()}}function changeItemType(e,t,a,n){var o,n=$("#".concat(n," .").concat(a)),a=e.item,e=e.action,i=n.find("."+a),r=i.find("[name="+a+"]");switch(0==r.length&&(r=i.find("[data-name="+a+"]")),e){case"show":o=t?"block":"none",i.css({cssText:"display:".concat(o," !important")});break;case"hide":o=t?"none":"block",i.css({cssText:"display:".concat(o," !important")});break;case"normal":o=!t,i.attr("required",o);break;case"required":o=!!t,i.attr("required",o);break;case"disabled":o=!!t,r.attr("disabled",o);break;case"nodisabled":o=!t,r.attr("disabled",o)}}function changeItemOption(n,o,e,t){var i,a=$("#".concat(t," .").concat(e)),r=n.item,e=n.item.split("-")[0],c=a.find("."+r);switch(e){case"e_select":var l=getProp(n.item,t).showPlaceholder;c.find(".p_input option").each(function(e,t){var a=l?e-1:e;0<=e&&(i=o&&n.itemValue[a]?"none":"block",$(t).css({cssText:"display:".concat(i," !important")}))});break;case"e_multipleSelect":c.find(".multSelect-option").find("div").each(function(e,t){i=o&&n.itemValue[e]?"none":"block",$(t).css({cssText:"display:".concat(i," !important")})});break;case"e_radio":case"e_checkbox":case"e_label":c.find(".p_input .form-check").each(function(e,t){i=o&&n.itemValue[e]?"none":"inline-flex",$(t).css({cssText:"display:".concat(i," !important")})})}}function changeItemValue(a,e,t,n,o){var i,r=$("#".concat(n," .").concat(t)),c=a.item,t=r.find("."+c),r=c.split("-")[0];if(-1<["e_select","e_multipleSelect","e_radio","e_checkbox","e_label"].indexOf(r))if(e){if("e_checkbox"==r||"e_radio"==r||"e_label"==r)t.find(".form-check").each(function(e,t){a.itemValue[e]?$(this).find(".form-check-input").prop("checked",!0):$(this).find(".form-check-input").prop("checked",!1)}),t.trigger("change");else if("e_select"==r){for(l in a.itemValue)a.itemValue[l]&&(i=l);t.trigger("select",i).trigger("change")}else if("e_multipleSelect"==r){var l,u=[];for(l in a.itemValue)a.itemValue[l]&&u.push(l);t.trigger("select",JSON.stringify(u)).trigger("change")}}else t.trigger("reset");else{var s,f,d,r="",p=t.find('[name="'+c+'"]');if(0==p.length&&(p=t.find('[data-name="'+c+'"]')),e)if(1==a.valueType)r=a.action;else if(2==a.valueType){var m,h=getElemValue(a.action,n);switch(Object.prototype.toString.call(h)){case"[object String]":case"[object Number]":m=[h];break;case"[object Object]":m=h.value?[h.value]:[];break;case"[object Array]":m=[],h.forEach(function(e){e.value&&m.push(e.value)})}r=m.join(",")}else if(7==a.valueType){var v,_=getElemValue(a.action,n);switch(Object.prototype.toString.call(_)){case"[object String]":case"[object Number]":v=[_];break;case"[object Object]":v=_.label?[_.label]:[];break;case"[object Array]":v=[],_.forEach(function(e){e.label&&v.push(e.label)})}r=v.join(",")}else 3==a.valueType?r=calculation(o[a.action].formula,n):4==a.valueType?r=getCookie(a.action)||"":5==a.valueType?r=$.getSearch()[a.action]:6==a.valueType&&(s=a.datasource,f=a.ddItem,getDatasource(s,function(e){var t;try{"object"==s.type?t=e.data.current:"list"==s.type&&(t=e.data.list[0])}catch(e){}t&&(d=t[f.outCode]),p.val(d).trigger("change")}));else r="";p.val(r).trigger("change")}}function mathCount(e,t){var a,n;return"max"==t?a=e.max():"min"==t?a=e.min():"average"==t&&(n=0,e.forEach(function(e){n+=Number(e)}),a=n/e.length),a}function calculation(data,cid){var formula=[],hasSubFormRow=!1,hasSubFormSum=!1;data.forEach(function(el){var arr,value,zs,_v,value,_value,gen,bei,gen,bei,_value,_value2,_gen,_bei,_gen,_bei,_value2,_v2,subf,_v3,_subf,v;"max"==el.type||"min"==el.type||"average"==el.type?(arr=[],el.item.forEach(function(e){var t;/^e_/.test(e.value)?("object"==_typeof(t=getElemValue(e.value,cid))&&(t=t.value),arr.push(t)):arr.push(e.value)}),formula.push(mathCount(arr,el.type))):"pow2"==el.type||"pow3"==el.type?(value=0,zs="pow2"==el.type?2:3,_v=calculation(el.item,cid),value=Math.pow(Number(_v),zs),formula.push(value)):"sqrt"==el.type?(_value=0,gen=calculation(el.genItem,cid),bei=calculation(el.beiItem,cid),_value=Math.pow(bei,1/gen),formula.push(_value)):"pown"==el.type?(_value2=0,_gen=calculation(el.genItem,cid),_bei=calculation(el.beiItem,cid),_value2=Math.pow(_bei,_gen),formula.push(_value2)):"subFormRow"==el.type?(_v2=[],subf=$("#".concat(cid," .").concat(el.subform)),subf.find(".p_tr").each(function(e,t){_v2.push(getRowSum($(t),e,el.item,cid))}),formula.push(_v2)):"subFormSum"==el.type?(_v3=[],_subf=$("#".concat(cid," .").concat(el.subform)),_subf.find(".p_tr").each(function(e,t){_v3.push(getRowSum($(t),e,el.item,cid))}),_v3=eval(_v3.join("+")),formula.push(_v3)):/^e_/.test(el.value)?(v=getElemValue(el.value,cid),"object"==_typeof(v)&&(v=v.value),formula.push(v)):formula.push(el.value)});var result="";try{var hasArr=formula.find(function(e){return"object"==_typeof(e)});hasArr?(result=[],hasArr.forEach(function(ee,ii){var tmpformula=[];"object"==_typeof(ee)?tmpformula.push(ee[ii]):tmpformula.push(ee),result.push(eval(tmpformula.join("")))})):result=eval(formula.join(""))}catch(error){$.pl_toast({msg:i18n.form_formulaError})}return result}function getRowSum(obj,index,data,cid){var formula=[];data.forEach(function(e){var t;"formIt"==e.type?(t=0!=index?"__"+(index+1):"","object"==_typeof(t=getElemValue(e.value+t,cid))&&(t=t.value),formula.push(t||0)):formula.push(e.value)});var result=0;try{result=eval(formula.join(""))}catch(error){}return result}function getDatasource(e,t){var a,n;e.api&&(a=JSON.parse(JSON.stringify(e.params)),n=$.getSearch(),a.query.forEach(function(e,t){"page"==e.sourceType&&("_detailId"!=e.value||n._detailId?e.value=n[e.value]||"":e.value=window.pageObj._detailId,a.query[t]=e)}),c.cmsAjax.postJson(e.api,a).then(function(e){t(e)}))}function needOption(e){return-1<e.findIndex(function(e){return e.isData})}function getOptionDatasource(e,u){var t=e.datasourceList,s=e.ddItemList,f=e.options,d=e.noRepeat,p=e.noRepeatFor,m={},h=0,v=0;f.forEach(function(r){var c,l;r.isData&&(m[r.value]=[],h++,c=Number(r.value.replace("data-","")),(l=t[c]).params.size=100,getDatasource(l,function(e){var a=[],t=[];try{var n,o=s[c].label.outCode,i=s[c].value.outCode;s[c].img&&(n=s[c].img.outCode),"object"==l.type?t=[e.data.current]:"list"==l.type&&(t=e.data.list),t.forEach(function(e){var t;e[o]&&e[i]&&(t={label:e[o],value:e[i]},n&&(t.img=e[n]),a.push(t))})}catch(e){}m[r.value]=a,v++,function(){{var t,e;h==v&&(t=[],f.forEach(function(e){e.isData?(e.select&&(m[e.value][0].select=!0),t.push.apply(t,m[e.value])):t.push(e)}),d&&(e=[],t.forEach(function(t){e.find(function(e){return e[p]==t[p]})||e.push(t)}),t=e),u(t))}}()}))})}function getI18n(e){e.indexOf("__")&&(e=e.split("__")[0]);var t=$("."+e).closest("[class^='e_form-']");if(0==t.length)return{};var a,n=e.split("-")[1],o=t.find('input[name="i18nJson"]').val()||"{}",i={};for(a in o=JSON.parse(o))a.endsWith("_"+n)&&(i[a.split("_")[0]]=o[a]);return i}return Array.prototype.max=function(){return Math.max.apply({},this)},Array.prototype.min=function(){return Math.min.apply({},this)},{getElemCname:getElemCname,getElemValue:getElemValue,getInputValue:getInputValue,getOption:getOption,getSubFormVaue:getSubFormVaue,getProp:getProp,formProp:formProp,getElemLabel:getElemLabel,getListContent:getListContent,txRule:txRule,doAction:doAction,calculation:calculation,getDatasource:getDatasource,needOption:needOption,getOptionDatasource:getOptionDatasource,getI18n:getI18n}});