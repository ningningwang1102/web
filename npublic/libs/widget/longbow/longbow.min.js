"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(f){function o(t,e){this.$element=f(t),this.options=f.extend({},o.DEFAULTS,e),this.$element.css({position:"relative",width:this.options.width+"px",margin:"0 auto"}),this.init()}o.VERSION="1.0",o.Author="argo@163.com",o.DEFAULTS={width:280,height:155,PI:Math.PI,sliderL:30,sliderR:9,offset:5,loadingText:i18n.longbow_loading,failedText:i18n.longbow_agin,barText:i18n.longbow_bar,repeatIcon:"fa fa-repeat",maxLoadCount:3,localImages:function(){return"images/Pic"+Math.round(4*Math.random())+".jpg"}},f.fn.sliderCaptcha=function(n){return this.each(function(){var t=f(this),e=t.data("lgb.SliderCaptcha"),i="object"===_typeof(n)&&n;e&&!/reset/.test(n)||(e||t.data("lgb.SliderCaptcha",e=new o(this,i)),"string"==typeof n&&e[n]())})};var t=(f.fn.sliderCaptcha.Constructor=o).prototype;t.init=function(){this.initDOM(),this.initImg(),this.bindEvents()},t.initDOM=function(){var t,e,i,n=function(t,e){t=document.createElement(t);return t.className=e,t},o=(t=this.options.width-2,e=this.options.height,(i=document.createElement("canvas")).width=t,i.height=e,i),s=o.cloneNode(!0),r=n("div","sliderContainer"),a=n("i","refreshIcon "+this.options.repeatIcon),l=i18n.longbow_refresh,d=n("div","sliderMask"),c=n("div","sliderbg"),h=n("div","slider"),p=n("i","fa fa-arrow-right sliderIcon"),u=n("span","sliderText");s.className="block",u.innerHTML=this.options.barText;n=this.$element;a.append(l),n.append(f(o)),n.append(f(a)),n.append(f(s)),h.appendChild(p),d.appendChild(h),r.appendChild(c),r.appendChild(d),r.appendChild(u),n.append(f(r)),Object.assign(this,{canvas:o,block:s,sliderContainer:f(r),refreshIcon:a,slider:h,sliderMask:d,sliderIcon:p,text:f(u),canvasCtx:o.getContext("2d"),blockCtx:s.getContext("2d")})},t.initImg=function(){function i(t,e){var i=a.options.sliderL,n=a.options.sliderR,o=a.options.PI,s=a.x,r=a.y;t.beginPath(),t.moveTo(s,r),t.arc(s+i/2,r-n+2,n,.72*o,2.26*o),t.lineTo(s+i,r),t.arc(s+i+n-2,r+i/2,n,1.21*o,2.78*o),t.lineTo(s+i,r+i),t.lineTo(s,r+i),t.arc(s+n-2,r+i/2,n+.4,2.76*o,1.24*o,!0),t.lineTo(s,r),t.lineWidth=2,t.fillStyle="rgba(255, 255, 255, 0.7)",t.strokeStyle="rgba(255, 255, 255, 0.7)",t.stroke(),t[e](),t.globalCompositeOperation=l?"xor":"overlay"}function n(t,e){return Math.round(Math.random()*(e-t)+t)}var a=this,l=-1<window.navigator.userAgent.indexOf("Trident"),o=this.options.sliderL+2*this.options.sliderR+3,s=new Image;s.crossOrigin="Anonymous";var r=0;s.onload=function(){a.x=n(o+10,a.options.width-(o+10)),a.y=n(10+2*a.options.sliderR,a.options.height-(o+10)),i(a.canvasCtx,"fill"),i(a.blockCtx,"clip"),a.canvasCtx.drawImage(s,0,0,a.options.width-2,a.options.height),a.blockCtx.drawImage(s,0,0,a.options.width-2,a.options.height);var t=a.y-2*a.options.sliderR-1,e=a.blockCtx.getImageData(a.x-3,t,o,o);a.block.width=o,a.blockCtx.putImageData(e,0,t),a.text.text(a.text.attr("data-text"))},s.onerror=function(){r++,"file:"===window.location.protocol&&(r=a.options.maxLoadCount),r>=a.options.maxLoadCount?a.text.text(i18n.longbow_fail).addClass("text-danger"):s.src=a.options.localImages()},s.setSrc=function(){var t,e="";r=0,a.text.removeClass("text-danger"),f.isFunction(a.options.setSrc)&&(e=a.options.setSrc()),e&&""!==e||(e="https://picsum.photos/"+a.options.width+"/"+a.options.height+"/?image="+Math.round(20*Math.random())),l?((t=new XMLHttpRequest).onloadend=function(t){var e=new FileReader;e.readAsDataURL(t.target.response),e.onloadend=function(t){s.src=t.target.result}},t.open("GET",e),t.responseType="blob",t.send()):s.src=e},s.setSrc(),this.text.attr("data-text",this.options.barText),this.text.text(this.options.loadingText),this.img=s},t.clean=function(){this.canvasCtx.clearRect(0,0,this.options.width,this.options.height),this.blockCtx.clearRect(0,0,this.options.width,this.options.height),this.block.width=this.options.width},t.bindEvents=function(){var n=this;this.$element.on("selectstart",function(){return!1}),f(this.refreshIcon).on("click",function(){n.text.text(n.options.barText),n.reset(),f.isFunction(n.options.onRefresh)&&n.options.onRefresh.call(n.$element)});function t(t){n.text.hasClass("text-danger")||(o=t.clientX||t.touches[0].clientX,s=t.clientY||t.touches[0].clientY,a=!0)}function e(t){if(!a)return!1;var e=t.clientX||t.touches[0].clientX,i=t.clientY||t.touches[0].clientY,t=e-o,e=i-s;if(t<0||40+t>n.options.width)return!1;n.slider.style.left=t-1+"px",i=(n.options.width-40-20)/(n.options.width-40)*t,n.block.style.left=i+"px",n.sliderContainer.addClass("sliderContainer_active"),n.sliderMask.style.width=4+t+"px",r.push(e)}function i(t){if(!a)return!1;if(a=!1,(t.clientX||t.changedTouches[0].clientX)==o)return!1;n.sliderContainer.removeClass("sliderContainer_active"),n.trail=r;var t=(e=n.verify()).spliced,e=e.verified;t&&e?(n.sliderContainer.addClass("sliderContainer_success"),f.isFunction(n.options.onSuccess)&&n.options.onSuccess.call(n.$element)):(n.sliderContainer.addClass("sliderContainer_fail"),f.isFunction(n.options.onFail)&&n.options.onFail.call(n.$element),setTimeout(function(){n.text.text(n.options.failedText),n.reset()},1e3))}var o,s,r=[],a=!1;this.slider.addEventListener("mousedown",t),this.slider.addEventListener("touchstart",t),document.addEventListener("mousemove",e),document.addEventListener("touchmove",e),document.addEventListener("mouseup",i),document.addEventListener("touchend",i),document.addEventListener("mousedown",function(){return!1}),document.addEventListener("touchstart",function(){return!1})},t.verify=function(){var t=function(t,e){return t+e},e=this.trail,i=e.reduce(t)/e.length,n=e.map(function(t){return t-i}),t=Math.sqrt(n.map(function(t){return t*t}).reduce(t)/e.length),e=parseInt(this.block.style.left);return{spliced:Math.abs(e-this.x)<this.options.offset,verified:0!==t}},t.reset=function(){this.sliderContainer.removeClass("sliderContainer_fail sliderContainer_success"),this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.text.attr("data-text",this.text.text()),this.text.text(this.options.loadingText),this.img.setSrc()}}(jQuery);